<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TV — PartyBox</title>
  <link rel="icon" href="/static/favicon.webp" type="image/webp" />
  <link rel="apple-touch-icon" href="/static/partybox_logo.webp" />
  <link rel="stylesheet" href="/static/style.css" />
</head>

<body class="tvPage">
  <div class="tv">
    <div class="playerWrap">
      <div id="player"></div>
    </div>
  </div>

  <!-- Top-left status pills -->
  <div style="position: fixed; left: 16px; top: 16px; display:flex; gap:10px; align-items:center; z-index: 50;">
    <div class="tvBrandIcon" aria-hidden="true"></div>
    <div class="pill">
      <span id="tv_dot" class="dot warn"></span>
      <span id="mode_label">PartyBox</span>
    </div>
    <div class="pill">
      <span class="muted">Now</span>
      <span id="now_label" class="ellip" style="max-width: 70vw;">—</span>
    </div>
  </div>

  <!-- Center overlay panel -->
  <div id="overlay_wrap" style="position: fixed; inset: 0; display:none; align-items:center; justify-content:center; z-index: 40; pointer-events:none;">
    <div class="panel" style="width: min(860px, calc(100vw - 56px));">
      <div class="panelHeader">
        <div>
          <div class="kicker" id="ov_kicker">PAUSED</div>
          <div class="hint" id="ov_hint">—</div>
        </div>
        <span id="ov_badge" class="badge paused">Paused</span>
      </div>
      <div class="panelInner">
        <div class="card">
          <div class="title" id="ov_title">No selection</div>
          <div class="sub" id="ov_sub">Admin paused playback</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let STATE = null;

    const el = (id) => document.getElementById(id);

    function setModePill(mode, tvOnline, avMode, locked) {
      const dot = el("tv_dot");
      dot.classList.remove("ok","warn","bad");

      // color rules
      if (!tvOnline) dot.classList.add("bad");
      else if ((avMode || "").toLowerCase() === "spotify") dot.classList.add("warn");
      else if (mode === "paused") dot.classList.add("warn");
      else dot.classList.add("ok");

      // label rules
      let label = "PartyBox";
      if ((avMode || "").toLowerCase() === "spotify") label = "Spotify";
      else if (locked) label = "Locked";
      else if (mode === "paused") label = "Paused";
      else label = "PartyBox";

      el("mode_label").textContent = label;
    }

    function showOverlay(show, kicker, hint, title, sub, badgeText) {
      const wrap = el("overlay_wrap");
      if (!show) { wrap.style.display = "none"; return; }
      wrap.style.display = "flex";

      el("ov_kicker").textContent = kicker || "";
      el("ov_hint").textContent = hint || "";
      el("ov_title").textContent = title || "";
      el("ov_sub").textContent = sub || "";

      const b = el("ov_badge");
      b.textContent = badgeText || "";
      b.className = "badge";
      if ((kicker || "").toLowerCase().includes("paused")) b.classList.add("paused");
      if ((kicker || "").toLowerCase().includes("spotify")) b.classList.add("paused");
      if ((kicker || "").toLowerCase().includes("locked")) b.classList.add("locked");
    }

    function updateFromState(tvOnline) {
      if (!STATE) return;

      const av = (STATE.av_mode || "partybox").toLowerCase();
      const locked = !!STATE.locked;
      const paused = !!STATE.paused;
      const mode = (STATE.mode || "").toLowerCase();

      const nowTitle = (STATE.now && STATE.now.title) ? STATE.now.title : "—";
      el("now_label").textContent = nowTitle;

      setModePill(mode, tvOnline, av, locked);

      // Overlay rules:
      // - Spotify: show Spotify overlay
      // - Locked: show locked overlay
      // - Paused + no selection: centered paused/no selection/admin paused
      // - Paused + has selection: show paused + title
      // - Otherwise: no overlay
      if (av === "spotify") {
        showOverlay(true, "SPOTIFY", "Audio mode", "Spotify active", "Video playback is disabled while Spotify is active.", "Spotify");
        return;
      }

      if (locked) {
        showOverlay(true, "LOCKED", "Requests", "Requests locked", "Only Admin can add to the queue right now.", "Locked");
        return;
      }

      if (paused) {
        if (!STATE.now) {
          showOverlay(true, "PAUSED", "No selection", "No selection", "Admin paused playback", "Paused");
        } else {
          showOverlay(true, "PAUSED", "Holding selection", STATE.now.title || "Selection", "Admin paused playback", "Paused");
        }
        return;
      }

      showOverlay(false);
    }

    async function pollState() {
      try {
        const r = await fetch("/api/state", { cache: "no-store" });
        STATE = await r.json();
      } catch (e) {
        // don't change UI on transient errors
      }
    }

    async function pollTvStatus() {
      // determines online via heartbeat age
      try {
        const r = await fetch("/api/tv/status", { cache: "no-store" });
        const j = await r.json();
        const st = (j && j.ok) ? j.status : null;
        const now = Math.floor(Date.now() / 1000);
        const online = !!(st && st.ts && (now - st.ts) <= 15);
        updateFromState(online);
      } catch (e) {
        // if we can’t read tv/status, assume offline indicator but still show state info
        updateFromState(false);
      }
    }

    async function tick() {
      await pollState();
      await pollTvStatus();
    }

    tick();
    setInterval(tick, 1000);
  </script>
</body>
</html>
