<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PartyBox TV — PartyBox</title>
  <style>
    html, body { margin:0; padding:0; background:#000; height:100%; overflow:hidden; }
    #wrap { position:relative; width:100%; height:100%; display:flex; flex-direction:column; }
    #top {
      padding:18px 22px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#fff;
      background: linear-gradient(rgba(0,0,0,0.72), rgba(0,0,0,0));
      font-size: 22px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.9);
    }
    #main {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      color:#fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      text-shadow: 0 2px 10px rgba(0,0,0,0.9);
    }
    .card {
      max-width: 980px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 22px;
      background: rgba(20,20,24,0.55);
    }
    .h1 { font-size: 44px; margin: 0 0 10px 0; }
    .h2 { font-size: 26px; margin: 0 0 10px 0; opacity: 0.95; }
    .p  { font-size: 22px; margin: 10px 0; opacity: 0.95; line-height: 1.25; }
    .muted { opacity: 0.72; }
    .pill {
      display:inline-block;
      padding:6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25);
      font-size: 16px;
      margin-left: 10px;
      vertical-align: middle;
    }
    #note {
      padding:18px 22px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#fff;
      background: linear-gradient(rgba(0,0,0,0), rgba(0,0,0,0.72));
      font-size: 24px;
      display:none;
      text-shadow: 0 2px 10px rgba(0,0,0,0.9);
    }
  </style>
</head>
<body>
<div id="wrap">
  <div id="top">PartyBox TV <span id="modepill" class="pill">…</span></div>

  <div id="main">
    <div class="card">
      <div id="title" class="h1">Loading…</div>
      <div id="line1" class="h2 muted"></div>
      <div id="line2" class="p"></div>
      <div id="line3" class="p muted"></div>
    </div>
  </div>

  <div id="note"></div>
</div>

<script>
const modepill = document.getElementById("modepill");
const title = document.getElementById("title");
const line1 = document.getElementById("line1");
const line2 = document.getElementById("line2");
const line3 = document.getElementById("line3");
const note  = document.getElementById("note");

async function apiState() {
  const r = await fetch("/api/state", {cache:"no-store"});
  if (!r.ok) throw new Error(`/api/state -> ${r.status}`);
  return await r.json();
}

function setNote(text) {
  const t = (text || "").trim();
  if (t) {
    note.textContent = t;
    note.style.display = "block";
  } else {
    note.style.display = "none";
  }
}

function renderSpotify(state) {
  modepill.textContent = "Spotify Mode";
  title.textContent = "Spotify Time";
  line1.textContent = "Anyone can connect (simple Spotify Connect).";
  line2.textContent = "Open Spotify → Devices → select: UJ-Partybox";
  line3.textContent = "This stays active until Admin switches back to Partybox.";
  setNote("");
}

function renderPartybox(state) {
  modepill.textContent = "Partybox Mode";

  if (state.paused) {
    title.textContent = "PAUSED";
    line1.textContent = state.now ? `Now: ${state.now.title}` : "No selection";
    line2.textContent = "Admin paused playback.";
    line3.textContent = "";
    setNote("");
    return;
  }

  if (!state.now) {
    title.textContent = "Idle";
    line1.textContent = "No videos available.";
    line2.textContent = "Add items in /admin or request from /u";
    line3.textContent = "";
    setNote("");
    return;
  }

  const now = state.now;
  const up  = state.up_next;

  title.textContent = "Now Playing";
  line1.textContent = now.title || "Unknown";
  line2.textContent = up && up.title ? `Up Next: ${up.title}` : "";
  line3.textContent = state.mode ? `Mode: ${state.mode}` : "";
  setNote(now.note_text || "");
}

async function poll() {
  try {
    const state = await apiState();
    const av = (state.av_mode || "partybox").toLowerCase();
    if (av === "spotify") renderSpotify(state);
    else renderPartybox(state);
  } catch (e) {
    modepill.textContent = "error";
    title.textContent = "TV error";
    line1.textContent = String(e);
    line2.textContent = "";
    line3.textContent = "";
    setNote("");
  }
}

setInterval(poll, 1000);
poll();
</script>
</body>
</html>
