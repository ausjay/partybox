{# templates/admin.html #}
{% extends "base.html" %}
{% block base_scripts %}{% endblock %}
{% block title %}Admin — PartyBox{% endblock %}

{% block body %}
<div class="appBg adminPage">
  <div class="page">

    <!-- Top Bar -->
    <div class="topbar">
      <div class="brandRow">
        <img class="brandWordmark" src="/static/partybox_t.png" alt="PartyBox" />
        <div class="brandAdminTag">Admin</div>
      </div>

      <div class="topActions">
        <div class="pill" title="System health">
          <span id="top_health_dot" class="dot warn"></span>
          <span id="top_health_text">System Health</span>
        </div>

        <div class="pill" title="Mode">
          <span id="top_mode_dot" class="dot {% if media_mode == 'mute' %}warn{% else %}ok{% endif %}"></span>
          <span id="top_mode_text">Mode: {{ media_mode|capitalize }}</span>
        </div>

        <div class="pill" title="Playback status">
          <span id="top_status_dot" class="dot {% if muted %}warn{% elif paused %}warn{% else %}ok{% endif %}"></span>
          <span id="top_status_text">
            {% if muted %}
              Status: Muted
            {% elif paused %}
              Status: Paused
            {% else %}
              Status: Playing
            {% endif %}
          </span>
        </div>

        <div id="top_lock_pill" class="pill" title="Requests lock" style="{% if not locked %}display:none;{% endif %}">
          <span id="top_lock_dot" class="dot bad"></span>
          <span id="top_lock_text"><b style="font-weight:800;">Requests Locked</b></span>
        </div>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="grid">

      <!-- Left: Now Playing + Controls -->
      <div class="panel panel-now" style="grid-column: span 6;">
        <div class="panelHeader">
          <div class="kicker">Now Playing</div>
          <div class="hint" id="now_header_hint">
            {% if paused %}
              <span class="badge paused">Paused</span>
            {% else %}
              <span class="badge playing">Live</span>
            {% endif %}
            {% if muted %}
              <span class="badge">Muted</span>
            {% endif %}
          </div>
        </div>

        <div class="panelInner">
          <!-- Now Playing Card (JS will keep this live) -->
          <div class="card" id="now_card">
            {% set now = (queue|selectattr("status","equalto","playing")|list|first) %}
            {% if now %}
              <div class="title ellip" id="now_title">{{ now.title }}</div>
              <div class="sub ellip" id="now_sub">
                {% if now.youtube_id.startswith("file:") %}
                  Local: {{ now.youtube_id[5:] }}
                {% else %}
                  YT: {{ now.youtube_id }}
                {% endif %}
                {% if now.note_text %} • Note: {{ now.note_text }}{% endif %}
              </div>

              <div class="kv" id="now_kv">
                <div class="k">Playback</div>
                <div class="v" id="kv_playback">{% if paused %}Paused{% else %}Playing{% endif %}{% if muted %} • Muted{% endif %}</div>

                <div class="k">Requests</div>
                <div class="v" id="kv_requests">{% if locked %}Locked{% else %}Open{% endif %}</div>

                <div class="k">A/V Mode</div>
                <div class="v" id="kv_av">{{ 'Spotify' if av_mode == 'spotify' else 'PartyBox' }}</div>
              </div>
            {% else %}
              <div class="title" id="now_title">Nothing marked playing</div>
              <div class="sub" id="now_sub">Queue item will appear here when playback starts (or when TV marks playing).</div>
              <div class="kv" id="now_kv" style="display:none;"></div>
            {% endif %}
          </div>

          <div style="height:12px;"></div>

          <!-- Control Sections -->
          <div class="panel" style="background: transparent; border: none; box-shadow: none;">
            <div class="panelHeader" style="padding: 0 0 10px; border-bottom: none;">
              <div class="kicker">Audio Mode</div>
              <div class="hint">Select one active source</div>
            </div>

            <div class="btnGroup audioControls">
              <button id="btn_mode_partybox" class="btn {% if media_mode == 'partybox' %}primary{% else %}ghost{% endif %}" onclick="setMediaMode('partybox')">PartyBox</button>
              <button id="btn_mode_spotify" class="btn {% if media_mode == 'spotify' %}primary{% else %}ghost{% endif %}" onclick="setMediaMode('spotify')">Spotify</button>
              <button id="btn_mode_airplay" class="btn {% if media_mode == 'airplay' %}primary{% else %}ghost{% endif %}" onclick="setMediaMode('airplay')">AirPlay</button>
              <button id="btn_mode_bluetooth" class="btn {% if media_mode == 'bluetooth' %}primary{% else %}ghost{% endif %}" onclick="setMediaMode('bluetooth')">Bluetooth</button>
              <button id="btn_mode_tv" class="btn {% if media_mode == 'tv' %}primary{% else %}ghost{% endif %}" onclick="setMediaMode('tv')">TV</button>
            </div>
            <div id="media_mode_status" class="muted" style="margin-top:8px; white-space:pre-line; display:none;"></div>

            <div style="height:12px;"></div>

            <div class="panelHeader" style="padding: 0 0 10px; border-bottom: none;">
              <div class="kicker">Playback Control</div>
              <div class="hint">Big buttons for bar screen</div>
            </div>

            <div class="btnGroup playbackControls">
              <button id="btn_pause_resume" class="btn {% if paused %}primary{% else %}pink{% endif %}" onclick="togglePauseResume()">
                {% if paused %}Resume{% else %}Pause{% endif %}
              </button>

              <button id="btn_skip" class="btn ghost" onclick="skip()">Skip</button>

              <button id="btn_mute" class="btn {% if muted %}primary{% else %}ghost{% endif %}" onclick="toggleMute()">
                {% if muted %}Unmute{% else %}Mute{% endif %}
              </button>

              <button id="btn_stop" class="btn danger btn-stop" onclick="tvStop()">Stop (pause + clear)</button>
            </div>

            <div style="height:12px;"></div>

            <div class="panelHeader" style="padding: 0 0 10px; border-bottom: none;">
              <div class="kicker">Requests & Queue</div>
              <div class="hint">Lock requests during “Spotify mode” or chaos</div>
            </div>

            <div class="btnGroup queueControls">
              <button id="btn_lock" class="btn {% if locked %}primary{% else %}ghost{% endif %}" onclick="toggleLock()">
                {{ "Unlock Requests" if locked else "Lock Requests" }}
              </button>

              <button id="btn_qr_toggle" class="btn {% if tv_qr_enabled %}primary{% else %}ghost{% endif %}" onclick="toggleTvQr()">
                {{ "Hide TV QR" if tv_qr_enabled else "Show TV QR" }}
              </button>

              <button class="btn ghost" onclick="clearQueue()">Clear Queue</button>
            </div>

            <div id="status" class="status"></div>
          </div>
        </div>
      </div>

      <!-- Right: Queue (LIVE) -->
      <div class="panel panel-queue" style="grid-column: span 6;">
        <div class="panelHeader">
          <div class="kicker">Queue</div>
          <div class="hint"><span id="queue_count">{{ queue|length }}</span> item(s)</div>
        </div>

        <div class="panelInner">
          <div id="queue_empty_card" class="card" style="{% if queue|length == 0 %}display:block;{% else %}display:none;{% endif %}">
            <div class="title">Queue is empty</div>
            <div class="sub">Add items or allow users to request.</div>
          </div>

          <div id="queue_list" class="list" style="{% if queue|length == 0 %}display:none;{% else %}display:flex; flex-direction:column; gap:10px;{% endif %}">
            {% set ns = namespace(n=0) %}
            {% for q in queue %}
              <div class="listrow" data-queue-id="{{ q.id }}">
                <div class="grow">
                  <div class="title ellip">
                    {% if q.status == 'playing' %}
                      Next. {{ q.title }}
                      <span class="badge playing" style="margin-left:10px;">playing</span>
                    {% else %}
                      {% set ns.n = ns.n + 1 %}
                      {{ ns.n }}. {{ q.title }}
                    {% endif %}
                  </div>

                  <div class="sub ellip">
                    {% if q.youtube_id.startswith("file:") %}
                      Local: {{ q.youtube_id[5:] }}
                    {% else %}
                      YT: {{ q.youtube_id }}
                    {% endif %}
                    {% if q.note_text %} • Note: {{ q.note_text }}{% endif %}
                  </div>
                </div>

                {% if q.status == "queued" %}
                  <button class="btn small ghost" onclick="promote({{ q.id }})">Promote</button>
                {% endif %}
                <button class="btn small danger" onclick="removeFromQueue({{ q.id }})">Remove</button>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Catalog Add -->
      <div class="panel panel-add" style="grid-column: span 6;">
        <div class="panelHeader">
          <div class="kicker">Add to Catalog</div>
          <div class="hint">YouTube URL/ID or Local.mp4</div>
        </div>

        <div class="panelInner">
          <div class="row" style="margin:0;">
            <input class="input" id="title" placeholder="Title (optional for local files)" />
            <input class="input" id="youtube_id" placeholder="YouTube URL / ID OR Local.mp4" />
            <button class="btn primary" onclick="addItem()">Add</button>
          </div>

          <div style="height:10px;"></div>

          <div class="btnGroup">
            <button class="btn ghost" onclick="mediaScan()">Media Scan</button>
          </div>

          <div class="muted" style="margin-top:10px;">
            Tip: Local files must already exist in <code style="color:rgba(234,246,255,0.85)">data/media</code>.
          </div>
        </div>
      </div>

      <!-- Catalog List (instant enable/disable UI) -->
      <div class="panel panel-catalog" style="grid-column: span 6;">
        <div class="panelHeader">
          <div class="kicker">Catalog</div>
          <div class="hint"><span id="catalog_count">{{ items|length }}</span> item(s)</div>
        </div>

        <div class="panelInner">
          <div class="list" id="catalog_list">
            {% for it in items %}
              <div class="listrow" data-catalog-id="{{ it.id }}" data-enabled="{{ 1 if it.enabled else 0 }}">
                <div class="grow">
                  <div class="title ellip">{{ it.title }}</div>
                  <div class="sub ellip">
                    {% if it.youtube_id.startswith("file:") %}
                      Local: {{ it.youtube_id[5:] }}
                    {% else %}
                      YT: {{ it.youtube_id }}
                    {% endif %}
                    <span class="badge locked" data-disabled-badge style="{% if it.enabled == 0 %}margin-left:8px; display:inline-flex;{% else %}display:none;{% endif %}">disabled</span>
                  </div>
                </div>

                <div class="btnGroup">
                  <button
                    class="btn small {% if it.enabled %}ghost{% else %}primary{% endif %}"
                    data-enable-btn
                    onclick="setEnabled({{ it.id }}, {{ 0 if it.enabled else 1 }})">
                    {{ "Disable" if it.enabled else "Enable" }}
                  </button>
                  <button class="btn small danger icon" title="Delete from catalog" onclick="deleteCatalog({{ it.id }})">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M4 7h16M9 7V5h6v2M9 10v7M12 10v7M15 10v7M6 7l1 13h10l1-13" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="panel panel-history" style="grid-column: span 12;">
        <div class="panelHeader">
          <div class="kicker">Last 25 Plays</div>
          <div class="hint">Time, mode, and best-effort metadata across PartyBox, Spotify, AirPlay, and Bluetooth</div>
        </div>
        <div class="panelInner">
          <div id="history_empty_card" class="card" style="display:none;">
            <div class="title">No play history yet</div>
            <div class="sub">Plays will appear here once something starts.</div>
          </div>
          <div style="overflow:auto;">
            <table id="history_table" style="width:100%; border-collapse:collapse; font-size:14px;">
              <thead>
                <tr style="text-align:left; color:rgba(200,220,240,0.9); border-bottom:1px solid rgba(255,255,255,0.12);">
                  <th style="padding:8px 6px;">Time</th>
                  <th style="padding:8px 6px;">Mode</th>
                  <th style="padding:8px 6px;">Artist</th>
                  <th style="padding:8px 6px;">Title</th>
                  <th style="padding:8px 6px;">Source</th>
                </tr>
              </thead>
              <tbody id="history_tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div> <!-- /grid -->

  </div> <!-- /page -->
</div> <!-- /appBg -->
{% endblock %}

{% block scripts %}
<script>
  const KEY = "{{ key|e }}";

  // local ui cache
  let STATE = {
    locked: {{ "true" if locked else "false" }},
    paused: {{ "true" if paused else "false" }},
    muted: {{ "true" if muted else "false" }},
    av_mode: "{{ av_mode|e }}",
    media_mode: "{{ media_mode|e }}",
    playback_mode: "{{ 'paused' if paused else 'playing' }}",
    media_mode_status: null,
    external_now_playing: {}
  };
  let PENDING_MEDIA_MODE = "";

  function post(path, body) {
    return fetch(path + `?key=${encodeURIComponent(KEY)}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body || {})
    }).then(async (r) => {
      const j = await r.json().catch(() => ({}));
      if (!r.ok) {
        const msg = j.error || `HTTP ${r.status}`;
        const err = new Error(msg);
        err.payload = j;
        throw err;
      }
      return j;
    });
  }

  function setStatus(t) {
    const el = document.getElementById('status');
    if (el) el.textContent = t || "";
  }

  // ---------- Live UI helpers ----------
  function setTopLock(locked) {
    const pill = document.getElementById("top_lock_pill");
    const dot = document.getElementById("top_lock_dot");
    const txt = document.getElementById("top_lock_text");
    pill.style.display = locked ? "" : "none";
    dot.classList.remove("ok","bad","warn");
    dot.classList.add("bad");
    txt.innerHTML = "<b style=\"font-weight:800;\">Requests Locked</b>";
    const btn = document.getElementById("btn_lock");
    btn.className = "btn " + (locked ? "primary" : "ghost");
    btn.textContent = locked ? "Unlock Requests" : "Lock Requests";
  }

  function modeLabel(mediaMode) {
    const m = String(mediaMode || "partybox").toLowerCase();
    if (m === "spotify") return "Mode: Spotify";
    if (m === "airplay") return "Mode: AirPlay";
    if (m === "bluetooth") return "Mode: Bluetooth";
    if (m === "tv") return "Mode: TV";
    if (m === "mute") return "Mode: Mute";
    return "Mode: PartyBox";
  }

  function setTopMode(mediaMode) {
    const dot = document.getElementById("top_mode_dot");
    const txt = document.getElementById("top_mode_text");
    dot.classList.remove("ok","warn","bad");

    const m = String(mediaMode || "partybox").toLowerCase();
    if (m === "mute") {
      dot.classList.add("warn");
    } else {
      dot.classList.add("ok");
    }
    txt.textContent = modeLabel(m);
  }

  function playbackStatusLabel(mediaMode, playbackMode, paused, muted) {
    const m = String(mediaMode || "partybox").toLowerCase();
    const p = String(playbackMode || "").toLowerCase();
    const isPaused = !!paused;
    const isMuted = !!muted;
    const externalNow = (STATE && STATE.external_now_playing && typeof STATE.external_now_playing === "object")
      ? STATE.external_now_playing
      : {};
    const btNow = (externalNow.bluetooth && typeof externalNow.bluetooth === "object")
      ? externalNow.bluetooth
      : {};
    const btDevice = String(btNow.device_name || "").trim();

    let base = "Idle";
    if (m === "mute") {
      base = "Muted";
    } else if (m === "bluetooth" && btDevice) {
      base = `Bluetooth Active • ${btDevice}`;
    } else if (m !== "partybox") {
      base = `${modeLabel(m).replace("Mode: ", "")} Active`;
    } else if (isPaused || p === "paused") {
      base = "Paused";
    } else if (p === "playing") {
      base = "Playing";
    } else if (p === "queue") {
      base = "Queued";
    }
    if (isMuted && base !== "Muted") return `${base} • Muted`;
    return base;
  }

  function setTopStatus(mediaMode, playbackMode, paused, muted) {
    const dot = document.getElementById("top_status_dot");
    const txt = document.getElementById("top_status_text");
    if (!dot || !txt) return;
    dot.classList.remove("ok", "warn", "bad");

    const m = String(mediaMode || "partybox").toLowerCase();
    const p = String(playbackMode || "").toLowerCase();
    const isPaused = !!paused || p === "paused";
    const isMuted = !!muted || m === "mute";

    if (isMuted) dot.classList.add("warn");
    else if (m !== "partybox" || p === "playing") dot.classList.add("ok");
    else if (isPaused || p === "queue" || p === "empty") dot.classList.add("warn");
    else dot.classList.add("ok");

    txt.textContent = `Status: ${playbackStatusLabel(m, p, isPaused, isMuted)}`;
  }

  function setTopHealth(ok, summary) {
    const dot = document.getElementById("top_health_dot");
    const txt = document.getElementById("top_health_text");
    const pill = dot ? dot.closest(".pill") : null;
    dot.classList.remove("ok","warn","bad");
    dot.classList.add(ok ? "ok" : "bad");
    if (ok) {
      txt.textContent = "System Health";
    } else {
      const failed = Number((summary && summary.failed) || 0);
      txt.textContent = failed > 0 ? `System Health Degraded (${failed})` : "System Health Degraded";
    }
    if (pill) {
      const failedChecks = (summary && Array.isArray(summary.failed_checks)) ? summary.failed_checks : [];
      pill.title = ok ? "System health" : `System health degraded: ${failedChecks.join(", ") || "unknown"}`;
    }
  }

  function buildHealthTooltip(j) {
    const checks = (j && j.checks) ? j.checks : {};
    const lines = [];
    const yn = (v) => v ? "OK" : "FAIL";

    const dbConnect = checks.db_connect || {};
    lines.push(`DB connect: ${yn(!!dbConnect.ok)}`);

    const dbQuery = checks.db_query || {};
    lines.push(`DB query: ${yn(!!dbQuery.ok)}`);

    const services = checks.services || {};
    const units = services.units || {};
    const unitNames = Object.keys(units).sort();
    if (unitNames.length) {
      lines.push(`Services: ${yn(!!services.ok)}`);
      unitNames.forEach((name) => {
        const s = units[name] || {};
        const bits = [];
        bits.push(yn(!!s.ok));
        if (s.active_state) bits.push(s.active_state);
        if (s.sub_state) bits.push(s.sub_state);
        if (s.user) bits.push(`user=${s.user}`);
        if (s.expected_user) bits.push(`expected=${s.expected_user}`);
        if (s.note) bits.push(String(s.note));
        lines.push(`- ${name}: ${bits.join(", ")}`);
      });
    }

    const hb = checks.tv_player_heartbeat || checks.tv_heartbeat || {};
    if (Object.keys(hb).length) {
      const age = Number(hb.age_seconds || 0);
      const max = Number(hb.max_age_seconds || 0);
      lines.push(`TV player heartbeat: ${yn(!!hb.ok)} (age ${age}s, max ${max}s)`);
    }

    const internet = checks.internet || {};
    if (Object.keys(internet).length) {
      lines.push(`Internet: ${yn(!!internet.ok)}`);
      const internetChecks = internet.checks || {};
      const tcp = internetChecks.tcp_1_1_1_1_53 || {};
      const https = internetChecks.https_generate_204 || {};
      if (Object.keys(tcp).length) lines.push(`- TCP 1.1.1.1:53: ${yn(!!tcp.ok)}`);
      if (Object.keys(https).length) {
        const code = https.status ? ` (${https.status})` : "";
        lines.push(`- HTTPS generate_204: ${yn(!!https.ok)}${code}`);
      }
    }

    const nginxHttp = checks.nginx_http || {};
    const nginxChecks = nginxHttp.checks || {};
    const nginxNames = Object.keys(nginxChecks).sort();
    if (nginxNames.length) {
      lines.push(`Nginx HTTP: ${yn(!!nginxHttp.ok)}`);
      nginxNames.forEach((name) => {
        const c = nginxChecks[name] || {};
        const expected = Array.isArray(c.expected_status)
          ? c.expected_status.join("|")
          : String(c.expected_status || "n/a");
        const status = Number(c.status || 0);
        const verdict = yn(!!c.ok);
        lines.push(`- ${name}: ${verdict} (${status}, expected ${expected})`);
      });
    }

    const fs = checks.filesystem || {};
    const fsPaths = fs.paths || {};
    const fsPathNames = Object.keys(fsPaths).sort();
    if (fsPathNames.length) {
      lines.push(`Filesystem: ${yn(!!fs.ok)}`);
      fsPathNames.forEach((p) => {
        const d = fsPaths[p] || {};
        if (d.error) {
          lines.push(`- ${p}: FAIL (${d.error})`);
          return;
        }
        lines.push(`- ${p}: ${yn(!!d.ok)} (${d.used_pct}% used, max ${d.max_used_pct}%)`);
      });
    }

    const mem = checks.memory || {};
    if (Object.keys(mem).length) {
      if (mem.error) {
        lines.push(`Memory: FAIL (${mem.error})`);
      } else {
        lines.push(`Memory: ${yn(!!mem.ok)} (${mem.used_pct}% used, max ${mem.max_used_pct}%)`);
      }
    }

    const desktop = checks.desktop_autostart || {};
    if (Object.keys(desktop).length) {
      if (desktop.error) {
        lines.push(`Desktop autostart: FAIL (${desktop.error})`);
      } else {
        const path = desktop.path ? ` (${desktop.path})` : "";
        lines.push(`Desktop autostart: ${yn(!!desktop.ok)}${path}`);
      }
    }

    return lines.join("\n");
  }

  function setPaused(paused, muted) {
    const btn = document.getElementById("btn_pause_resume");
    btn.className = "btn " + (paused ? "primary" : "pink");
    btn.textContent = paused ? "Resume" : "Pause";
    const currentMode = effectiveMediaMode(STATE && STATE.media_mode_status);
    setTopMode(currentMode);
    setTopStatus(currentMode, STATE && STATE.playback_mode, paused, muted);

    // Update header badges
    const hint = document.getElementById("now_header_hint");
    const parts = [];
    if (paused) parts.push('<span class="badge paused">Paused</span>');
    else parts.push('<span class="badge playing">Live</span>');
    if (muted) parts.push('<span class="badge">Muted</span>');
    hint.innerHTML = parts.join(" ");
  }

  function setMuted(muted) {
    const btn = document.getElementById("btn_mute");
    btn.className = "btn " + (muted ? "primary" : "ghost");
    btn.textContent = muted ? "Unmute" : "Mute";
    const currentMode = effectiveMediaMode(STATE && STATE.media_mode_status);
    setTopStatus(currentMode, STATE && STATE.playback_mode, STATE && STATE.paused, muted);
  }

  function playbackControlsEnabled(mediaMode) {
    return String(mediaMode || "partybox").toLowerCase() === "partybox";
  }

  function setPlaybackControlsEnabled(mediaMode) {
    const enabled = playbackControlsEnabled(mediaMode);
    const reason = enabled ? "" : "Playback controls are only available in PartyBox mode.";
    ["btn_pause_resume", "btn_skip", "btn_stop"].forEach((id) => {
      const btn = document.getElementById(id);
      if (!btn) return;
      btn.disabled = !enabled;
      btn.title = reason;
    });
  }

  function setTvQrEnabled(enabled) {
    const b = document.getElementById("btn_qr_toggle");
    if (!b) return;
    b.className = "btn " + (enabled ? "primary" : "ghost");
    b.textContent = enabled ? "Hide TV QR" : "Show TV QR";
  }

  function setMediaModeButtons(mode) {
    const m = String(mode || "partybox").toLowerCase();
    const names = ["partybox", "spotify", "airplay", "bluetooth", "tv"];
    names.forEach((name) => {
      const btn = document.getElementById(`btn_mode_${name}`);
      if (!btn) return;
      btn.className = "btn " + (m === name ? "primary" : "ghost");
    });
  }

  function setMediaModeButtonsEnabled(enabled) {
    const names = ["partybox", "spotify", "airplay", "bluetooth", "tv"];
    names.forEach((name) => {
      const btn = document.getElementById(`btn_mode_${name}`);
      if (!btn) return;
      btn.disabled = !enabled;
    });
  }

  function effectiveMediaMode(status) {
    const pending = String(PENDING_MEDIA_MODE || "").toLowerCase();
    if (pending) return pending;
    const statusMode = String((status && status.mode) || "").toLowerCase();
    if (statusMode) return statusMode;
    const stateMode = String((STATE && STATE.media_mode) || "").toLowerCase();
    if (stateMode) return stateMode;
    return "partybox";
  }

  function renderMediaModeStatus(status) {
    const box = document.getElementById("media_mode_status");
    const mode = effectiveMediaMode(status);
    setMediaModeButtons(mode);
    if (!box) return;

    if (!status || typeof status !== "object") {
      box.textContent = "";
      box.style.display = "none";
      return;
    }

    if (status.last_error) {
      box.textContent = `Mode issue: ${status.last_error}`;
      box.style.display = "block";
      return;
    }
    box.textContent = "";
    box.style.display = "none";
  }

  function updateNowCardFromState(state) {
    // This uses /api/state for PartyBox queue and Spotify metadata.
    const now = state.now;
    const spotify = state.spotify || {};
    const externalNow = state.external_now_playing || {};
    const mediaMode = (state.media_mode || "partybox").toLowerCase();

    const titleEl = document.getElementById("now_title");
    const subEl = document.getElementById("now_sub");
    const kvEl = document.getElementById("now_kv");
    if (!document.getElementById("kv_playback")) {
      kvEl.innerHTML = `
        <div class="k">Playback</div>
        <div class="v" id="kv_playback">—</div>
        <div class="k">Requests</div>
        <div class="v" id="kv_requests">—</div>
        <div class="k">A/V Mode</div>
        <div class="v" id="kv_av">—</div>
      `;
    }
    const kvPlayback = document.getElementById("kv_playback");
    const kvRequests = document.getElementById("kv_requests");
    const kvAv = document.getElementById("kv_av");

    if (mediaMode === "spotify") {
      const track = spotify.track || {};
      const title = (track.name || "").trim();
      const artists = Array.isArray(track.artists) ? track.artists.filter(Boolean).join(", ") : "";
      const album = (track.album || "").trim();
      const deviceName = (((spotify.device || {}).name) || "").trim();
      const accountName = ((((spotify.account || {}).display_name) || "").trim());
      const err = (spotify.error || "").toString().trim();
      const playbackState = String(spotify.state || "").toLowerCase();
      const uiState = String(spotify.ui_state || "").toLowerCase();
      const uiMessage = (spotify.ui_message || "").toString().trim();
      const connectHint = (spotify.connect_hint || "").toString().trim();

      if (uiState === "playing_on_partybox" && title) {
        titleEl.textContent = title;
        const parts = [];
        if (artists) parts.push(artists);
        if (album) parts.push(album);
        if (deviceName) parts.push(`Device: ${deviceName}`);
        if (accountName) parts.push(`Account: ${accountName}`);
        if (err) parts.push(`Spotify API: ${err}`);
        subEl.textContent = parts.length ? parts.join(" • ") : "Spotify playback active.";
      } else {
        titleEl.textContent = uiMessage || "Waiting for Spotify Connect...";
        const parts = [];
        if (connectHint) parts.push(connectHint);
        if (deviceName && uiState === "playing_elsewhere") parts.push(`Current device: ${deviceName}`);
        if (accountName) parts.push(`Account: ${accountName}`);
        if (err && uiState !== "rate_limited") parts.push(`Spotify API: ${err}`);
        subEl.textContent = parts.length ? parts.join(" • ") : "Spotify idle (no active playback on PartyBox).";
      }

      kvEl.style.display = "grid";
      if (uiState === "playing_on_partybox" && (playbackState === "playing" || playbackState === "paused")) {
        kvPlayback.textContent = playbackState[0].toUpperCase() + playbackState.slice(1);
      } else if (uiState === "rate_limited") {
        kvPlayback.textContent = "Rate limited";
      } else if (uiState === "playing_elsewhere") {
        kvPlayback.textContent = "Playing elsewhere";
      } else {
        kvPlayback.textContent = "Waiting";
      }
      kvRequests.textContent = state.locked ? "Locked" : "Open";
      kvAv.textContent = "Spotify";
      return;
    }

    if (mediaMode === "airplay" || mediaMode === "bluetooth") {
      const ext = externalNow[mediaMode] || {};
      const active = !!ext.active;
      const title = (ext.title || "").toString().trim();
      const artist = (ext.artist || "").toString().trim();
      const album = (ext.album || "").toString().trim();
      const device = (ext.device_name || "").toString().trim();
      const metadataAvailable = !!ext.metadata_available;
      const modeLabelText = mediaMode === "airplay" ? "AirPlay" : "Bluetooth";

      if (active && metadataAvailable && title) {
        titleEl.textContent = title;
      } else if (active) {
        titleEl.textContent = `${modeLabelText} audio active`;
      } else {
        titleEl.textContent = `${modeLabelText} idle`;
      }

      const parts = [];
      if (artist) parts.push(artist);
      if (album) parts.push(album);
      if (device) parts.push(`Device: ${device}`);
      if (!metadataAvailable && active) parts.push("Metadata unavailable");
      if (!active) parts.push(`Waiting for ${modeLabelText} stream`);
      subEl.textContent = parts.length ? parts.join(" • ") : `${modeLabelText} receiver ready.`;

      kvEl.style.display = "grid";
      kvPlayback.textContent = active ? "Streaming" : "Waiting";
      kvRequests.textContent = state.locked ? "Locked" : "Open";
      kvAv.textContent = modeLabelText;
      return;
    }

    if (!now) {
      titleEl.textContent = "Nothing playing / queued";
      subEl.textContent = "Queue item will appear here when playback starts.";
      kvEl.style.display = "none";
      return;
    }

    titleEl.textContent = now.title || "(untitled)";

    const yid = (now.youtube_id || "");
    const pretty = yid.startsWith("file:") ? ("Local: " + yid.slice(5)) : ("YT: " + yid);
    const note = (now.note_text || "").trim();
    subEl.textContent = note ? (pretty + " • Note: " + note) : pretty;

    kvEl.style.display = "grid";

    kvPlayback.textContent = (state.paused ? "Paused" : "Playing") + (state.muted ? " • Muted" : "");
    kvRequests.textContent = state.locked ? "Locked" : "Open";
    kvAv.textContent = modeLabel(mediaMode, false).replace("Mode: ", "");
  }

  function renderQueue(items) {
    const list = document.getElementById("queue_list");
    const empty = document.getElementById("queue_empty_card");
    const cnt = document.getElementById("queue_count");

    items = Array.isArray(items) ? items : [];
    const playing = items.filter(q => String(q.status || "").toLowerCase() === "playing");
    const queued = items.filter(q => String(q.status || "").toLowerCase() !== "playing");
    items = [...playing, ...queued];
    cnt.textContent = String(items.length);

    if (!items.length) {
      empty.style.display = "block";
      list.style.display = "none";
      list.innerHTML = "";
      return;
    }

    empty.style.display = "none";
    list.style.display = "flex";
    list.innerHTML = "";

    let queueOrdinal = 1;
    items.forEach((q) => {
      const row = document.createElement("div");
      row.className = "listrow" + (q.status === "playing" ? " playing" : "");
      row.dataset.queueId = q.id;

      const left = document.createElement("div");
      left.className = "grow";

      const t = document.createElement("div");
      t.className = "title ellip";

      if (q.status === "playing") {
        t.textContent = "Next. " + (q.title || "(untitled)");
        const badge = document.createElement("span");
        badge.className = "badge playing";
        badge.style.marginLeft = "10px";
        badge.textContent = "playing";
        t.appendChild(badge);
      } else {
        t.textContent = `${queueOrdinal}. ${q.title || "(untitled)"}`;
        queueOrdinal += 1;
      }

      const sub = document.createElement("div");
      sub.className = "sub ellip";
      const yid = (q.youtube_id || "");
      const pretty = yid.startsWith("file:") ? ("Local: " + yid.slice(5)) : ("YT: " + yid);
      const note = (q.note_text || "").trim();
      sub.textContent = note ? (pretty + " • Note: " + note) : pretty;

      left.appendChild(t);
      left.appendChild(sub);

      row.appendChild(left);

      if (q.status === "queued") {
        const promoteBtn = document.createElement("button");
        promoteBtn.className = "btn small ghost";
        promoteBtn.textContent = "Promote";
        promoteBtn.onclick = () => promote(q.id);
        row.appendChild(promoteBtn);
      }

      const rmBtn = document.createElement("button");
      rmBtn.className = "btn small danger";
      rmBtn.textContent = "Remove";
      rmBtn.onclick = () => removeFromQueue(q.id);
      row.appendChild(rmBtn);

      list.appendChild(row);
    });
  }

  function fmtLocalTs(ts) {
    const n = Number(ts || 0);
    if (!n) return "—";
    try {
      return new Date(n * 1000).toLocaleString();
    } catch (e) {
      return String(n);
    }
  }

  function renderHistory(items) {
    const rows = Array.isArray(items) ? items : [];
    const tbody = document.getElementById("history_tbody");
    const empty = document.getElementById("history_empty_card");
    if (!tbody || !empty) return;
    tbody.innerHTML = "";

    if (!rows.length) {
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    rows.forEach((it) => {
      const tr = document.createElement("tr");
      tr.style.borderBottom = "1px solid rgba(255,255,255,0.08)";

      const mode = (it.mode || "unknown").toString().trim().toLowerCase();
      const title = (it.title || "").toString().trim() || "Unknown";
      const artist = (it.artist || "").toString().trim() || "Unknown";
      const source = (it.provider_id || it.uri || "").toString().trim() || "—";

      const cols = [
        fmtLocalTs(it.ts),
        mode,
        artist,
        title,
        source,
      ];
      cols.forEach((txt) => {
        const td = document.createElement("td");
        td.style.padding = "8px 6px";
        td.textContent = txt;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function updateCatalogRowEnabled(id, enabled) {
    const row = document.querySelector(`[data-catalog-id="${id}"]`);
    if (!row) return;

    row.dataset.enabled = enabled ? "1" : "0";

    const badge = row.querySelector(`[data-disabled-badge]`);
    if (badge) badge.style.display = enabled ? "none" : "inline-flex";

    const btn = row.querySelector(`[data-enable-btn]`);
    if (btn) {
      btn.className = "btn small " + (enabled ? "ghost" : "primary");
      btn.textContent = enabled ? "Disable" : "Enable";
      btn.setAttribute("onclick", `setEnabled(${id}, ${enabled ? 0 : 1})`);
    }
  }

  // ---------- Admin actions ----------
  function addItem() {
    const title = document.getElementById('title').value.trim();
    const youtube_id = document.getElementById('youtube_id').value.trim();
    setStatus("");
    post('/api/admin/catalog_add', {title, youtube_id})
      .then(j => {
        setStatus("Added.");
        // simplest: full reload so new item appears in the list
        location.reload();
      })
      .catch(e => setStatus('Error: ' + (e.message || 'unknown')));
  }

  function setEnabled(id, enabled) {
    setStatus("");
    // optimistic UI
    updateCatalogRowEnabled(id, !!enabled);
    post('/api/admin/catalog_enable', {id, enabled: !!enabled})
      .then(j => {
        setStatus("Saved.");
        // make sure UI reflects actual result
        updateCatalogRowEnabled(id, !!enabled);
      })
      .catch(e => {
        // rollback
        updateCatalogRowEnabled(id, !enabled);
        setStatus('Error: ' + (e.message || 'unknown'));
      });
  }

  function deleteCatalog(id) {
    if (!confirm("Delete this catalog item? This also removes it from the queue.")) return;
    setStatus("");
    post('/api/admin/catalog_delete', {id})
      .then(j => {
        if (!j.ok) throw new Error(j.error || "Delete failed");
        const row = document.querySelector(`[data-catalog-id="${id}"]`);
        if (row) row.remove();
        const cnt = document.getElementById("catalog_count");
        if (cnt) cnt.textContent = String(Math.max(0, Number(cnt.textContent || "0") - 1));
        setStatus("Deleted.");
        pollQueue();
        pollState();
      })
      .catch(e => setStatus('Error: ' + (e.message || 'unknown')));
  }

  function toggleLock() {
    setStatus("");
    const next = !STATE.locked;
    // optimistic
    STATE.locked = next;
    setTopLock(next);

    post('/api/admin/lock', {locked: next})
      .then(() => setStatus(next ? "Requests locked." : "Requests unlocked."))
      .catch(e => {
        // rollback
        STATE.locked = !next;
        setTopLock(!next);
        setStatus('Error: ' + (e.message || 'unknown'));
      });
  }

  function toggleTvQr() {
    setStatus("");
    const current = !!(STATE && STATE.tv_qr_enabled);
    const next = !current;
    if (!STATE) STATE = {};
    STATE.tv_qr_enabled = next;
    setTvQrEnabled(next);

    post('/api/admin/tv_qr', {enabled: next})
      .then(() => setStatus(next ? "TV QR enabled." : "TV QR disabled."))
      .catch(e => {
        STATE.tv_qr_enabled = !next;
        setTvQrEnabled(!next);
        setStatus('Error: ' + (e.message || 'unknown'));
      });
  }

  function skip() {
    setStatus("");
    post('/api/admin/skip', {})
      .then(() => { setStatus("Skipped."); pollQueue(); pollState(); })
      .catch(e => setStatus('Error: ' + (e.message || 'unknown')));
  }

  function clearQueue() {
    setStatus("");
    post('/api/admin/clear_queue', {})
      .then(() => { setStatus("Queue cleared."); pollQueue(); pollState(); })
      .catch(e => setStatus('Error: ' + (e.message || 'unknown')));
  }

  function removeFromQueue(queue_id) {
    setStatus("");
    post('/api/admin/queue_remove', {queue_id})
      .then(() => { setStatus("Removed."); pollQueue(); pollState(); })
      .catch(e => setStatus('Error: ' + (e.message || 'unknown')));
  }

  function promote(queue_id) {
    setStatus("");
    post('/api/admin/queue_promote', {queue_id})
      .then(() => { setStatus("Promoted."); pollQueue(); pollState(); })
      .catch(e => setStatus('Error: ' + (e.message || 'unknown')));
  }

  function togglePauseResume() {
    if (STATE.paused) tvResume();
    else tvPause();
  }

  function tvPause() {
    setStatus("");
    // optimistic
    STATE.paused = true;
    setPaused(true, STATE.muted);
    post('/api/admin/tv_pause', {})
      .then(() => { setStatus("Paused."); pollState(); })
      .catch(e => { STATE.paused = false; setPaused(false, STATE.muted); setStatus('Error: ' + (e.message || 'unknown')); });
  }

  function tvResume() {
    setStatus("");
    STATE.paused = false;
    setPaused(false, STATE.muted);
    post('/api/admin/tv_resume', {})
      .then(() => { setStatus("Resumed."); pollState(); })
      .catch(e => { STATE.paused = true; setPaused(true, STATE.muted); setStatus('Error: ' + (e.message || 'unknown')); });
  }

  function tvStop() {
    setStatus("");
    // stop implies pause+clear
    STATE.paused = true;
    setPaused(true, STATE.muted);
    post('/api/admin/tv_stop', {})
      .then(() => { setStatus("Stopped."); pollQueue(); pollState(); })
      .catch(e => setStatus('Error: ' + (e.message || 'unknown')));
  }

  function toggleMute() {
    if (STATE.muted) tvUnmute();
    else tvMute();
  }

  function tvMute() {
    setStatus("");
    STATE.muted = true;
    setMuted(true);
    setPaused(STATE.paused, true);
    post('/api/admin/tv_mute', {})
      .then(() => { setStatus("Muted."); pollState(); })
      .catch(e => { STATE.muted = false; setMuted(false); setPaused(STATE.paused, false); setStatus('Error: ' + (e.message || 'unknown')); });
  }

  function tvUnmute() {
    setStatus("");
    STATE.muted = false;
    setMuted(false);
    setPaused(STATE.paused, false);
    post('/api/admin/tv_unmute', {})
      .then(() => { setStatus("Unmuted."); pollState(); })
      .catch(e => { STATE.muted = true; setMuted(true); setPaused(STATE.paused, true); setStatus('Error: ' + (e.message || 'unknown')); });
  }

  function mediaScan() {
    setStatus("");
    post('/api/admin/media_scan', {})
      .then(j => { setStatus(`Media scan: seen ${j.seen_mp4}, added ${j.added}, disabled_missing ${j.disabled_missing}`); location.reload(); })
      .catch(e => setStatus('Error: ' + (e.message || 'unknown')));
  }

  function setMediaMode(mode) {
    mode = String(mode || "").toLowerCase();
    if (!mode) return;
    if (PENDING_MEDIA_MODE) return;
    setStatus("");
    const prevMode = STATE.media_mode;
    PENDING_MEDIA_MODE = mode;
    setMediaModeButtonsEnabled(false);
    STATE.media_mode = mode;
    setTopMode(mode);
    setTopStatus(mode, STATE.playback_mode, STATE.paused, STATE.muted);
    setPlaybackControlsEnabled(mode);
    renderMediaModeStatus(STATE.media_mode_status);
    setStatus(`Switching mode to ${mode}...`);

    post('/api/admin/media_mode', {mode})
      .then((j) => {
        if (j && j.ok === false) {
          const err = new Error(j.error || "mode switch failed");
          err.payload = j;
          throw err;
        }
        PENDING_MEDIA_MODE = "";
        setMediaModeButtonsEnabled(true);
        STATE.media_mode = (j.mode || mode).toLowerCase();
        STATE.media_mode_status = j.status || null;
        setTopMode(STATE.media_mode);
        setTopStatus(STATE.media_mode, STATE.playback_mode, STATE.paused, STATE.muted);
        renderMediaModeStatus(STATE.media_mode_status);
        setStatus(`Mode set: ${STATE.media_mode}`);
        pollState();
      })
      .catch(e => {
        const payload = e && e.payload ? e.payload : null;
        PENDING_MEDIA_MODE = "";
        setMediaModeButtonsEnabled(true);
        STATE.media_mode = String((payload && payload.mode) || prevMode || "partybox").toLowerCase();
        if (payload && payload.status) STATE.media_mode_status = payload.status;
        setTopMode(STATE.media_mode);
        setTopStatus(STATE.media_mode, STATE.playback_mode, STATE.paused, STATE.muted);
        setPlaybackControlsEnabled(STATE.media_mode);
        renderMediaModeStatus(STATE.media_mode_status);
        setStatus('Error: ' + (e.message || 'unknown'));
        pollState();
      });
  }

  // ---------- Polling (THIS fixes admin not updating when user adds queue items) ----------
  async function pollQueue() {
    try {
      const r = await fetch("/api/queue", { cache: "no-store" });
      const j = await r.json();
      renderQueue(j.items || []);
    } catch (e) {
      // ignore transient
    }
  }

  async function pollHistory() {
    try {
      const r = await fetch("/api/history?limit=25", { cache: "no-store" });
      const j = await r.json();
      if (!r.ok || !j || j.ok === false) return;
      renderHistory(j.items || []);
    } catch (e) {
      // ignore transient
    }
  }

  async function pollState() {
    try {
      const r = await fetch("/api/state", { cache: "no-store" });
      const j = await r.json();
      STATE = {
        locked: !!j.locked,
        paused: !!j.paused,
        muted: !!j.muted,
        av_mode: (j.av_mode || "partybox").toLowerCase(),
        media_mode: (j.media_mode || "partybox").toLowerCase(),
        playback_mode: (j.mode || "empty").toLowerCase(),
        tv_qr_enabled: !!(j.tv_qr_enabled ?? true),
        now: j.now || null,
        spotify: j.spotify || null,
        external_now_playing: j.external_now_playing || {},
        media_mode_status: j.media_mode_status || null
      };
      if (PENDING_MEDIA_MODE && STATE.media_mode === PENDING_MEDIA_MODE) {
        PENDING_MEDIA_MODE = "";
        setMediaModeButtonsEnabled(true);
      }

      setTopLock(STATE.locked);
      const currentMode = effectiveMediaMode(STATE.media_mode_status);
      setTopMode(currentMode);
      setMediaModeButtons(currentMode);
      setTopStatus(currentMode, STATE.playback_mode, STATE.paused, STATE.muted);
      setPlaybackControlsEnabled(STATE.media_mode);
      setMuted(STATE.muted);
      setPaused(STATE.paused, STATE.muted);
      setTvQrEnabled(STATE.tv_qr_enabled);
      renderMediaModeStatus(STATE.media_mode_status);
      updateNowCardFromState({
        locked: STATE.locked,
        paused: STATE.paused,
        muted: STATE.muted,
        av_mode: STATE.av_mode,
        media_mode: STATE.media_mode,
        now: STATE.now,
        spotify: STATE.spotify,
        external_now_playing: STATE.external_now_playing
      });

    } catch (e) {
      // ignore transient
    }
  }

  async function pollMediaModeStatus() {
    try {
      const r = await fetch(`/api/admin/media_mode_status?key=${encodeURIComponent(KEY)}`, { cache: "no-store" });
      const j = await r.json();
      if (!j || !j.ok) return;
      if (!STATE) STATE = {};
      STATE.media_mode_status = j.status || null;
      const reportedMode = String(((j.status || {}).mode) || "").toLowerCase();
      if (PENDING_MEDIA_MODE && reportedMode && reportedMode === PENDING_MEDIA_MODE) {
        PENDING_MEDIA_MODE = "";
        setMediaModeButtonsEnabled(true);
      }
      renderMediaModeStatus(STATE.media_mode_status);
      const currentMode = effectiveMediaMode(STATE.media_mode_status);
      setTopMode(currentMode);
      setTopStatus(currentMode, STATE.playback_mode, STATE.paused, STATE.muted);
    } catch (e) {
      // ignore transient
    }
  }

  async function pollHealth() {
    try {
      const r = await fetch(`/api/admin/health?key=${encodeURIComponent(KEY)}`, { cache: "no-store" });
      const j = await r.json();
      setTopHealth(!!j.ok, j.summary || {});
      const dot = document.getElementById("top_health_dot");
      const pill = dot ? dot.closest(".pill") : null;
      if (pill) pill.title = buildHealthTooltip(j);
    } catch (e) {
      setTopHealth(false, { failed: 1, failed_checks: ["health_endpoint"] });
    }
  }

  // init
  pollState();
  pollQueue();
  pollHistory();
  pollHealth();
  pollMediaModeStatus();

  // keep it live
  setInterval(pollState, 30000);
  setInterval(pollQueue, 1200);
  setInterval(pollHistory, 7000);
  setInterval(pollHealth, 5000);
  setInterval(pollMediaModeStatus, 5000);
</script>
{% endblock %}
