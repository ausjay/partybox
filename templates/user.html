{% extends "base.html" %}
{% block body %}
<div class="page">
  <h1>Pick Next Video</h1>

  {% if locked %}
    <div class="banner warn">Requests are currently locked by admin.</div>
  {% endif %}

  <div class="grid">
    {% for it in items %}
      <button class="card" onclick="requestVideo({{ it.id }}, '{{ it.title|e }}')" {% if locked %}disabled{% endif %}>
        <div class="title">{{ it.title }}</div>
        <div class="sub">Tap to add to queue</div>
      </button>
    {% endfor %}
  </div>

  <div class="msgbox">
    <input id="note" placeholder="Optional message (e.g. Happy birthday Ju)" maxlength="120" />
  </div>

  <h2>Queue</h2>
  <div class="list">
    {% if queue|length == 0 %}
      <div class="muted">Queue is empty.</div>
    {% else %}
      {% for q in queue %}
        <div class="listrow {% if q.status == 'playing' %}playing{% endif %}">
          <div class="grow">
            <div class="title">
              {% if q.status == 'playing' %}â–¶{% else %}{{ loop.index }}.{% endif %}
              {{ q.title }}
            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

  <div id="status" class="status"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function requestVideo(catalogId, title) {
    const note = document.getElementById('note').value || '';
    fetch('/api/request_video', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({catalog_id: catalogId, note_text: note})
    }).then(r => r.json()).then(j => {
      const s = document.getElementById('status');
      if (j.ok) {
        s.textContent = `Queued: ${title}`;
        document.getElementById('note').value = '';
        // simplest: reload to update queue list
        setTimeout(() => location.reload(), 250);
      } else {
        s.textContent = `Error: ${j.error || 'unknown'}`;
      }
    }).catch(() => {
      document.getElementById('status').textContent = 'Network error';
    });
  }
</script>
<script>
let lastSig = "";

async function pollQueue() {
  try {
    const r = await fetch('/api/queue', {cache:'no-store'});
    const j = await r.json();
    const sig = JSON.stringify((j.items||[]).map(x => [x.id, x.status, x.pos]));

    if (lastSig && sig !== lastSig) {
      location.reload();
    }

    lastSig = sig;
  } catch (_) {}
}

setInterval(pollQueue, 3000);
pollQueue();
</script>

{% endblock %}
