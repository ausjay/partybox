{% extends "base.html" %}
{% block title %}Pick a Video — PartyBox{% endblock %}
{% block body %}

<div class="page">
  <h1>Pick Next Video</h1>

  <!-- Spotify overlay (JS toggles this) -->
  <div id="spotify_overlay" style="display:none; padding:16px; margin:12px 0; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(20,20,24,0.55);">
    <div style="font-size:28px; font-weight:700;">Spotify Time</div>
    <div style="margin-top:8px;">Open Spotify → Devices → select: <b>UJ-Partybox</b></div>
    <div style="margin-top:8px; opacity:0.8;">Partybox requests are paused until Admin switches back.</div>
  </div>

  <!-- Lock banner (always present so JS can toggle it) -->
  <div id="locked_banner" class="banner warn" style="display:none;">
    Requests are currently locked by admin.
  </div>

  <div class="grid">
    {% for it in items %}
      <button class="card" onclick='requestVideo({{ it.id }}, {{ it.title|tojson }})'>
        <div class="title">{{ it.title }}</div>
        <div class="sub">Tap to add to queue</div>
      </button>
    {% endfor %}
  </div>

  <div class="msgbox">
    <input id="note" placeholder="Optional message (e.g. Happy birthday Ju)" maxlength="120" />
  </div>

  <h2>Queue</h2>
  <div class="list">
    {% if queue|length == 0 %}
      <div class="muted">Queue is empty.</div>
    {% else %}
      {% for q in queue %}
        <div class="listrow {% if q.status == 'playing' %}playing{% endif %}">
          <div class="grow">
            <div class="title">
              {% if q.status == 'playing' %}▶{% else %}{{ loop.index }}.{% endif %}
              {{ q.title }}
            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

  <div id="status" class="status"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function requestVideo(catalogId, title) {
    const note = document.getElementById('note').value || '';
    fetch('/api/request_video', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({catalog_id: catalogId, note_text: note})
    }).then(r => r.json()).then(j => {
      const s = document.getElementById('status');
      if (j.ok) {
        s.textContent = `Queued: ${title}`;
        document.getElementById('note').value = '';
        setTimeout(() => location.reload(), 250);
      } else {
        s.textContent = `Error: ${j.error || 'unknown'}`;
      }
    }).catch(() => {
      document.getElementById('status').textContent = 'Network error';
    });
  }
</script>

<script>
  // ---- Live state/queue refresh ----
  let lastQueueSig = "";
  let lastStateSig = "";

  function setButtonsDisabled(disabled) {
    document.querySelectorAll('button.card').forEach(b => { b.disabled = !!disabled; });
  }

  function applyStateUI(state) {
    const av = (state.av_mode || 'partybox').toLowerCase();
    const locked = !!state.locked;

    // Show/hide spotify overlay
    const so = document.getElementById('spotify_overlay');
    so.style.display = (av === 'spotify') ? 'block' : 'none';

    // Show/hide locked banner
    const lb = document.getElementById('locked_banner');
    lb.style.display = locked ? 'block' : 'none';

    // Disable buttons if locked OR spotify mode
    setButtonsDisabled(locked || av === 'spotify');
  }

  async function pollState() {
    try {
      const r = await fetch('/api/state', {cache:'no-store'});
      const s = await r.json();

      // Trigger a hard refresh if admin flips anything that affects /u
      const sig = JSON.stringify([
        (s.av_mode || 'partybox'),
        !!s.locked,
        !!s.paused,
        !!s.muted,
        (s.mode || '')
      ]);

      applyStateUI(s);

      if (lastStateSig && sig !== lastStateSig) {
        location.reload();
        return;
      }
      lastStateSig = sig;
    } catch (_) {}
  }

  async function pollQueue() {
    try {
      const r = await fetch('/api/queue', {cache:'no-store'});
      const j = await r.json();

      const sig = JSON.stringify((j.items||[]).map(x => [x.id, x.status, x.pos]));
      if (lastQueueSig && sig !== lastQueueSig) {
        location.reload();
        return;
      }
      lastQueueSig = sig;
    } catch (_) {}
  }

  // Start quickly, then keep checking
  pollState();
  pollQueue();
  setInterval(pollState, 2000);
  setInterval(pollQueue, 3000);
</script>
{% endblock %}
